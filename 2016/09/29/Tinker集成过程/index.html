<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!--<![endif]-->

<head>
  <title>Tinker集成过程 | Dinghongyan</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Dinghongyan">
    <meta name="author" content="Ding">
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="Dinghongyan" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
	
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    
    

    <!-- Custom stylesheet, (add custom styles here, always load last) -->
    <!-- Load our stylesheet for IE8 -->
    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- Google Webfonts (Monserrat 400/700, Open Sans 400/600) -->
    <link href='//fonts.useso.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
    <link href='//fonts.useso.com/css?family=Open+Sans:400,600' rel='stylesheet' type='text/css'>

    <!-- Load our fonts individually if IE8+, to avoid faux bold & italic rendering -->
    <!--[if IE]>
    <link href='http://fonts.useso.com/css?family=Montserrat:400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Montserrat:700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Open+Sans:400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Open+Sans:600' rel='stylesheet' type='text/css'>
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->










  
  
  

  
  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            <li>
                <a class="sb-toggle-submenu">Works<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                        <li><a href="/" target="_BLANK" class="animsition-link">AAA</a></li>
                    
                        <li><a href="/atom.xml" target="_BLANK" class="animsition-link">BBB</a></li>
                    
                </ul>
            </li>
            
            
            
            <li>
                <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                    <li><a href="http://go.kieran.top/" class="animsition-link">Kieran</a></li>
                    
                    <li><a href="http://domain.com/" class="animsition-link">Name</a></li>
                    
                </ul>
            </li>
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">Dinghongyan</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a></li>
                            
                            
                            <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a></li>
                            
                            
                            <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a></li>
                            
                            
                            <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a></li>
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->


      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2016-09-29T02:42:21.000Z" itemprop="datePublished">
          2016-09-29
      </time>
    
    
    | 
    <a href='/tags/Tinker/'>Tinker</a>,
    
    <a href='/tags/热修复/'>热修复</a>,
    
    <a href='/tags/android热修复/'>android热修复</a>
    
    
</span>
                <h1>Tinker集成过程</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<h4 id="Tinker集成过程重点"><a href="#Tinker集成过程重点" class="headerlink" title="Tinker集成过程重点"></a>Tinker集成过程重点</h4><p>官方对于集成重要的几步已经有说明，详情请查看官方文档。这里只列出一些容易出错的几点。</p>
<p><strong>1. 调用assembleDebug编译命令</strong><br>将cmd 目录定位到项目根目录下（如c:testcode\tinker\tinker-sample-android）</p>
<blockquote>
<p>gradlew assembleDebug</p>
</blockquote>
<p><strong>2. 编译报错：can’t get git rev, you should add git to system path or just input test value, such as ‘testTinkerId’ </strong></p>
<p>分析：出错代码在：build.gradle</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">def gitSha() &#123;</div><div class="line">    try &#123;</div><div class="line">        //获取最后一次提交的hash值作为TinkerID，并写入到manifest.xml;</div><div class="line">        //这里因为没有提交，所以获取不到，为了调试方便，直接写一个值。</div><div class="line">        //!!注意：TinkerId不能设置为非常短的数字，例如“1.0”</div><div class="line">        return &quot;5.6.020160928&quot;</div><div class="line"></div><div class="line">        String gitRev = &apos;git rev-parse --short HEAD&apos;.execute().text.trim()</div><div class="line">        if (gitRev == null) &#123;</div><div class="line">            throw new GradleException(&quot;can&apos;t get git rev, you should add git to system path or just input test value, such as &apos;testTinkerId&apos;&quot;)</div><div class="line">        &#125;</div><div class="line">        return gitRev</div><div class="line">    &#125; catch (Exception e) &#123;</div><div class="line">        throw new GradleException(&quot;can&apos;t get git rev, you should add git to system path or just input test value, such as &apos;testTinkerId&apos;&quot;)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此方法的调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">def getTinkerIdValue() &#123;</div><div class="line">    return hasProperty(&quot;TINKER_ID&quot;) ? TINKER_ID : gitSha()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出<strong>getSha()</strong> 是用于获取一个字符串，作为TINKER_ID。</p>
<p>报错原因是：第一次clone下来代码，没有提交过，所以git HEAD里 获取不到 最后一次提交的hash值。导致tinkerId 写入manifest.xml失败。<br>如果需要使用这个值,操作方法为：</p>
<ul>
<li>安装git，及环境变量（安装是否成功检测方案：git –version）</li>
<li>在simple-demo下修改一个文件，然后提交。</li>
<li>再次执行编译。</li>
</ul>
<p><strong>3. 打Patch包：</strong></p>
<p>直接使用task:tinkerPatchVariantName(例如tinkerPatchDebug、tinkerPatchRelease)即可自动根据Variant选择相应的编译类型,<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&gt;gradlew tinkerPathDebug</div><div class="line"></div><div class="line">**4. 自定义Application类**</div><div class="line"></div><div class="line">程序启动时会加载默认的Application类，这导致我们补丁包是无法对它做修改了。如何规避？在这里我们并没有使用类似InstantRun hook Application的方式，而是通过代码框架的方式来避免，这也是为了尽量少的去反射，提升框架的兼容性。</div><div class="line"></div><div class="line">这里我们要实现的是完全将原来的Application类隔离起来，即其他任何类都不能再引用我们自己的Application。我们需要做的其实是以下几个工作：</div><div class="line"></div><div class="line">1. 将我们自己Application的所有代码拷贝到自己的ApplicationLike继承类中，例如SampleApplicationLike;</div><div class="line">2. Application的attachBaseContext方法实现要单独移动到onBaseContextAttached中；</div><div class="line">3. 对ApplicationLike中，引用application的地方改成getApplication();</div><div class="line">4. 对其他引用Application或者它的静态对象与方法的地方，改成引用ApplicationLike的静态对象与方法；</div><div class="line"></div><div class="line">**5.Application代理类**</div><div class="line"></div><div class="line">为了使真正的Application实现可以在补丁包中修改，我们把Appliction类的所有逻辑移动到ApplicationLike代理类中。</div></pre></td></tr></table></figure></p>
<p>public class YourApplication extends Application {<br>    ActivityLifecycleCallbacks activityLifecycleCallbacks;<br>    public void setTinkerActivityLifecycleCallbacks(ActivityLifecycleCallbacks activityLifecycleCallbacks) {<br>        this.activityLifecycleCallbacks = activityLifecycleCallbacks;<br>    }<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- 然后将你的Application类继承TinkerApplication.java。除了构造方法之外，你最好不要引入其他的类，这将导致它们无法通过补丁修改。</div></pre></td></tr></table></figure></p>
<p>public class SampleApplication extends TinkerApplication {<br>    public SampleApplication() {<br>      super(<br>        //tinkerFlags, tinker支持的类型，dex,library，还是全部都支持！<br>        ShareConstants.TINKER_ENABLE_ALL,<br>        //ApplicationLike的实现类，只能传递字符串<br>        “tinker.sample.android.app.SampleApplicationLike,<br>        //Tinker的加载器，一般来说用默认的即可<br>        “com.tencent.tinker.loader.TinkerLoader”,<br>        //tinkerLoadVerifyFlag, 运行加载时是否校验dex与,ib与res的Md5<br>        false);<br>    }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- 使用Annotation生成Application类:</div><div class="line"></div><div class="line">为了隐藏你的Application类，我们更加推荐你使用tinker-android-anno在运行时生成你的Application类。这样保证你无法修改你的Application类，不会因为错误操作导致引入更多无法修改的类。</div><div class="line"></div><div class="line">若采用Annotation生成Application,需要将原来的Application类删掉。到此为止，Tinker初步的接入已真正的完成，你已经可以愉快的使用Tinker来实现补丁功能了。</div></pre></td></tr></table></figure></p>
<p>@DefaultLifeCycle(<br>application = “.SampleApplication”,                       //application类名<br>flags = ShareConstants.TINKER_ENABLE_ALL,                 //tinkerFlags<br>loaderClass = “com.tencent.tinker.loader.TinkerLoader”,   //loaderClassName, 我们这里使用默认即可!<br>loadVerifyFlag = false)                                   //tinkerLoadVerifyFlag<br>public class SampleApplicationLike extends DefaultApplicationLike<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">最终APP中不需要Application，只用一个ApplicationLike即可。Demo中完整代码如下：</div></pre></td></tr></table></figure></p>
<p>@SuppressWarnings(“unused”)<br>@DefaultLifeCycle(application = “tinker.sample.android.app.SampleApplication”,<br>                  flags = ShareConstants.TINKER_ENABLE_ALL,<br>                  loadVerifyFlag = false)<br>public class SampleApplicationLike extends DefaultApplicationLike {<br>    private static final String TAG = “Tinker.SampleApplicationLike”;</p>
<pre><code>public SampleApplicationLike(Application application, int tinkerFlags, boolean tinkerLoadVerifyFlag,
                             long applicationStartElapsedTime, long applicationStartMillisTime, Intent tinkerResultIntent,
                             Resources[] resources, ClassLoader[] classLoader, AssetManager[] assetManager) {
    super(application, tinkerFlags, tinkerLoadVerifyFlag, applicationStartElapsedTime, applicationStartMillisTime, tinkerResultIntent, resources, classLoader, assetManager);
}

/**
 * install multiDex before install tinker
 * so we don&apos;t need to put the tinker lib classes in the main dex
 *
 * @param base
 */
@TargetApi(Build.VERSION_CODES.ICE_CREAM_SANDWICH)
@Override
public void onBaseContextAttached(Context base) {
    super.onBaseContextAttached(base);
    //you must install multiDex whatever tinker is installed!
    MultiDex.install(base);

    SampleApplicationContext.application = getApplication();
    SampleApplicationContext.context = getApplication();
    TinkerManager.setTinkerApplicationLike(this);
    TinkerManager.initFastCrashProtect();
    //should set before tinker is installed
    TinkerManager.setUpgradeRetryEnable(true);

    //optional set logIml, or you can use default debug log
    TinkerInstaller.setLogIml(new MyLogImp());

    //installTinker after load multiDex
    //or you can put com.tencent.tinker.** to main dex
    TinkerManager.installTinker(this);
}

@TargetApi(Build.VERSION_CODES.ICE_CREAM_SANDWICH)
public void registerActivityLifecycleCallbacks(Application.ActivityLifecycleCallbacks callback) {
    getApplication().registerActivityLifecycleCallbacks(callback);
}
</code></pre><p>}</p>
<p>```</p>
<p><strong>6. Release的使用方法</strong></p>
<p>Tinker的使用方式如下，以gradle接入的release包为例：</p>
<ul>
<li>每次编译或发包将安装包与mapping文件备份；</li>
<li>若有补丁包的需要，按自身需要修改你的代码、库文件等；</li>
<li>将备份的基准安装包与mapping文件输入到tinkerPatch的配置中；</li>
<li>运行tinkerPatchRelease，即可自动编译最新的安装包，并与输入基准包作差异，得到最终的补丁包。</li>
<li>将补丁包通过接口下发给有bug的客户端版本。客户端更新后做本地标识，避免重复修复patch.</li>
</ul>
<p><strong><em>注意</em></strong>：</p>
<p>如果multiDexEnabled为true，将自动生成Tinker需要放在主dex的keep规则，你需要拷贝它到自己的multiDexKeepProguard文件中。这是因为它是一个单独的文件，而proguardFiles是一个list。输出路径为：build/intermediates/tinker_intermediates/tinker_multidexkeep.pro。 后你可以在build/outputs/tinkerPatch中找到输出的文件。</p>
<p>参考文档</p>
<ol>
<li><a href="https://github.com/Tencent/tinker/wiki/Tinker-%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97" target="_blank" rel="external">腾讯官方接入指南</a></li>
<li><a href="https://github.com/Tencent/tinker/wiki" target="_blank" rel="external">腾讯官方wiki首页</a></li>
</ol>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="pagination" role="pagination">
    
    
    <a class="pull-right" href="/2016/09/20/使用GithubPages搭建自己的博客/">
        使用GithubPages搭建自己的博客 →
    </a>
    
</nav>

        <div class="duoshuo">
<div class="ds-thread" data-thread-key="2016/09/29/Tinker集成过程/" data-title="Tinker集成过程" data-url="http://yoursite.com/2016/09/29/Tinker集成过程/"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"dinghy"};
(function() {
	var ds = document.createElement('script');
	ds.type = 'text/javascript';ds.async = true;
	ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
	ds.charset = 'UTF-8';
	(document.getElementsByTagName('head')[0] 
	 || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script>
</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By Ding. All Rights Reserved.
                </p>
                <p>Theme By <a href="//go.kieran.top" style="color: #767D84">Kieran</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a>&nbsp;</li>
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
        
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };
    
    resizeHero();
    
    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/jquery.flexslider-min.js"></script><!-- Flexslider plugin -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->

<!-- Initiate flexslider plugin -->
<script type="text/javascript">
    $(document).ready(function($) {
      $('.flexslider').flexslider({
        animation: "fade",
        prevText: "",
        nextText: "",
        directionNav: true
      });
    });
</script>

</body>
</html>
